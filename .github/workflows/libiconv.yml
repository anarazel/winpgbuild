on:
  workflow_dispatch:

jobs:
  build-libiconv:
    runs-on: windows-latest
    steps:
      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: git mingw-w64-ucrt-x86_64-gcc
          
      - name: Debug
        run: | 
          mkdir /foo
        shell: msys2 {0}
        
      - name: Env
        run: | 
          set
        shell: msys2 {0}

      - name: PWD
        run: | 
          pwd
        shell: msys2 {0}

      - name: mnt
        run: | 
          ls -al /mnt/
        shell: msys2 {0}
        
      - name: Download
        run: | 
          curl https://ftp.gnu.org/pub/gnu/libiconv/libiconv-${{ vars.LIBICONV_VERSION }}.tar.gz -o ./libiconv-${{ vars.LIBICONV_VERSION }}.tar.gz
          tar zxvf libiconv-${{ vars.LIBICONV_VERSION }}.tar.gz
        shell: msys2 {0}

      - name: Configure
        run: | 
          cd libiconv-${{ vars.LIBICONV_VERSION }}
          ./configure --prefix=//d/a/libiconv
        shell: msys2 {0}
          
      - name: Build
        run: | 
          cd libiconv-${{ vars.LIBICONV_VERSION }}
          make all
        shell: msys2 {0}

      - name: Install
        run: |
          cd libiconv-${{ vars.LIBICONV_VERSION }}
          make install

          cp \libiconv\include\libiconv.dll.a \libiconv\include\iconv.lib
          cp \libiconv\include\libcharset.dll.a \libiconv\include\charset.lib
        shell: msys2 {0}

      - name: Upload
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: libiconv-${{ vars.OSSP_UUID_VERSION }}-win64
          path: /libiconv
